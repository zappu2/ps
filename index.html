<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PasarSkin - Inventory Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 40px;
            text-align: center;
        }

        .logo {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 14px;
            letter-spacing: 0.05em;
        }

        /* Added styles for the add item form */
        .add-item-form {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .form-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #e2e8f0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 10px 16px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 12px;
        }

        .btn-primary {
            padding: 10px 20px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            padding: 10px 20px;
            background: #475569;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #334155;
        }

        .form-preview {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            display: none;
        }

        .form-preview.show {
            display: block;
        }

        .preview-item {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 6px;
        }

        .preview-item strong {
            color: #e2e8f0;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 10px 20px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        button.active {
            background: #06b6d4;
        }

        input[type="text"] {
            padding: 10px 16px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            width: 200px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            backdrop-filter: blur(10px);
        }

        .metric-label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-positive {
            color: #10b981;
        }

        .metric-negative {
            color: #ef4444;
        }

        .metric-neutral {
            color: #3b82f6;
        }

        .metric-change {
            font-size: 12px;
            color: #94a3b8;
        }

        .table-wrapper {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 12px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .table-header {
            background: rgba(15, 23, 42, 0.6);
            padding: 16px;
            border-bottom: 1px solid #334155;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(15, 23, 42, 0.6);
            color: #94a3b8;
            font-size: 12px;
            font-weight: 600;
            text-align: left;
            padding: 12px 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #334155;
            position: sticky;
            top: 0;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        }

        tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .item-name {
            font-weight: 500;
            color: #e2e8f0;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .neutral {
            color: #64748b;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid #334155;
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab:hover {
            color: #cbd5e1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .profit-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .profit-indicator.positive {
            background: #10b981;
        }

        .profit-indicator.negative {
            background: #ef4444;
        }

        .delete-btn {
            padding: 4px 8px;
            background: #ef4444;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .edit-btn {
            padding: 4px 8px;
            background: #3b82f6;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            margin-right: 4px;
        }

        .edit-btn:hover {
            background: #2563eb;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #e2e8f0;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        input[type="date"] {
            padding: 10px 16px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            font-family: inherit;
            color-scheme: dark;
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-box {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 48px;
            width: 90%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .login-logo {
            font-size: 48px;
            text-align: center;
            margin-bottom: 16px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            color: #94a3b8;
            font-size: 14px;
            text-align: center;
            margin-bottom: 32px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 16px;
            margin-bottom: 16px;
            font-family: inherit;
        }

        .login-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .login-button {
            width: 100%;
            padding: 14px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-button:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        .login-error {
            color: #ef4444;
            font-size: 14px;
            text-align: center;
            margin-top: 16px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #475569;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .logout-btn:hover {
            background: #334155;
        }

        .app-container {
            display: none;
        }

        .app-container.unlocked {
            display: block;
        }

        input[type="date"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        input[type="password"] {
            padding: 10px 16px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            font-family: inherit;
        }

        input[type="password"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        @media (max-width: 768px) {
            .metrics {
                grid-template-columns: 1fr;
            }

            input[type="text"] {
                width: 100%;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }

            .metric-value {
                font-size: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-logo">ðŸ”’</div>
            <div class="login-title">PasarSkin Access</div>
            <div class="login-subtitle">Enter password to continue</div>
            <input 
                type="password" 
                id="passwordInput" 
                class="login-input" 
                placeholder="Password"
                onkeypress="if(event.key === 'Enter') auth.login()"
            >
            <button class="login-button" onclick="auth.login()">Unlock</button>
            <div id="loginError" class="login-error">Incorrect password. Please try again.</div>
        </div>
    </div>

    <!-- Logout Button -->
    <button id="logoutBtn" class="logout-btn" onclick="auth.logout()" style="display: none;">ðŸ”“ Logout</button>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container">
    <div class="container">
        <header>
            <div class="logo">ðŸŽ® PasarSkin</div>
            <div class="subtitle">CS:GO Skin Trading Inventory Tracker</div>
            <div id="storageStatus" style="margin-top: 10px; font-size: 12px; color: #64748b;"></div>
            
            <!-- Cycle Selector -->
            <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center; align-items: center; flex-wrap: wrap;">
                <label style="color: #94a3b8; font-size: 14px; font-weight: 500;">Current Cycle:</label>
                <select id="cycleSelector" onchange="app.switchCycle(this.value)" style="padding: 8px 16px; background: #1e293b; border: 1px solid #334155; border-radius: 8px; color: #e2e8f0; font-size: 14px;">
                    <option value="1">Cycle 1</option>
                </select>
                <button onclick="app.createNewCycle()" class="btn-primary" style="padding: 8px 16px; font-size: 13px;">+ New Cycle</button>
                <button onclick="app.manageCycles()" class="btn-secondary" style="padding: 8px 16px; font-size: 13px;">Manage Cycles</button>
                <button onclick="app.renderSettingsModal()" class="btn-secondary" style="padding: 8px 16px; font-size: 13px;">Settings</button>
            </div>
        </header>

        <!-- Added form section for adding new items -->
        <div class="add-item-form">
            <div class="form-title">Add New Inventory Item</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="skinName">Skin Name *</label>
                    <input type="text" id="skinName" placeholder="e.g., AK-47 | Dragon Lore">
                </div>
                <div class="form-group">
                    <label for="condition">Condition</label>
                    <select id="condition">
                        <option value="">Select condition (optional)</option>
                        <option value="Factory New">Factory New</option>
                        <option value="Minimal Wear">Minimal Wear</option>
                        <option value="Field-Tested">Field-Tested</option>
                        <option value="Well-Worn">Well-Worn</option>
                        <option value="Battle-Scarred">Battle-Scarred</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="buyPriceIDR">Buy Price (IDR) *</label>
                    <input type="text" id="buyPriceIDR" placeholder="e.g., 1000000">
                </div>
                <div class="form-group">
                    <label for="youPinPrice">Current YouPin Price *</label>
                    <input type="text" id="youPinPrice" placeholder="e.g., 450.50">
                </div>
                <div class="form-group">
                    <label for="salePriceOverride">Sale Price (Override)</label>
                    <input type="text" id="salePriceOverride" placeholder="Auto-calculated if empty">
                </div>
                <div class="form-group">
                    <label for="buyDate">Buy Date (Optional)</label>
                    <input type="date" id="buyDate">
                </div>
                <div class="form-group">
                    <label for="sellDate">Sell Date (Optional)</label>
                    <input type="date" id="sellDate">
                </div>
                <div class="form-group">
                    <label for="itemStatus">Status</label>
                    <select id="itemStatus">
                        <option value="in-stock">In Stock</option>
                        <option value="sold">Sold</option>
                        <option value="not-tradable">Not Tradable</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="itemMethod">Method</label>
                    <select id="itemMethod">
                        <option value="Pricempire">Pricempire</option>
                        <option value="Cashout">Cashout</option>
                    </select>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="itemNote">Note (Optional)</label>
                    <input type="text" id="itemNote" placeholder="Add any notes here...">
                </div>
            </div>

            <!-- Added calculation preview before adding item -->
            <div class="form-preview" id="formPreview">
                <div class="preview-item">Price CNY: <strong id="previewPriceCNY">-</strong></div>
                <div class="preview-item">Sale Price (with 0.99 tax): <strong id="previewSalePrice">-</strong></div>
                <div class="preview-item">Profit After Tax: <strong id="previewProfit" class="positive">-</strong></div>
                <div class="preview-item">Profit Margin: <strong id="previewMargin" class="positive">-</strong></div>
            </div>

            <div class="form-actions">
                <button class="btn-primary" onclick="app.addItem()">Add Item</button>
                <button class="btn-secondary" onclick="app.resetForm()">Clear</button>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="searchInput" placeholder="Search by skin name...">
            <button onclick="app.filterByStatus('all')" class="active" id="filterAll">All Items</button>
            <button onclick="app.filterByStatus('active')" id="filterActive">Active</button>
            <button onclick="app.filterByStatus('sold')" id="filterSold">Sold</button>
            <div style="margin-left: auto; display: flex; gap: 12px; align-items: center;">
                <span style="font-size: 12px; color: #94a3b8;">View:</span>
                <button onclick="app.switchViewMode('simple')" id="viewSimple" class="active">Simple</button>
                <button onclick="app.switchViewMode('complete')" id="viewComplete">Complete</button>
            </div>
            <!-- Added export/import buttons -->
            <button onclick="app.exportToJSON()" class="btn-primary" style="margin-left: auto;">ðŸ“¥ Export JSON</button>
            <button onclick="document.getElementById('importFile').click()" class="btn-primary">ðŸ“¤ Import JSON</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="app.importFromJSON(event)">
        </div>

        <div class="metrics" id="metricsContainer"></div>

        <div class="tabs">
            <button class="tab active" onclick="app.switchTab('inventory')">Inventory</button>
            <button class="tab" onclick="app.switchTab('summary')">Summary</button>
            <button class="tab" onclick="app.switchTab('people')">People Breakdown</button>
        </div>

        <div class="tab-content active" id="inventoryTab">
            <div class="table-wrapper">
                <div class="table-header">
                    <div class="table-title">Current Inventory</div>
                </div>
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Skin Name</th>
                            <th>Condition</th>
                            <th>Price IDR</th>
                            <th>Price CNY</th>
                            <th>YouPin</th>
                            <th>Sale Price</th>
                            <th>Sale Price (IDR)</th>
                            <th>Profit</th>
                            <th>Margin %</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="summaryTab">
            <div class="table-wrapper">
                <div class="table-header">
                    <div class="table-title">Cycle Summary</div>
                </div>
                <table id="summaryTable">
                    <thead>
                        <tr>
                            <th>Cycle</th>
                            <th>Items</th>
                            <th>Total Investment (IDR)</th>
                            <th>Total Investment (CNY)</th>
                            <th>Profit %</th>
                            <th>Total Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="peopleTab">
            <!-- Add Person Form -->
            <div class="add-item-form">
                <div class="form-title">Add New Person Entry</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="personName">Person Name *</label>
                        <select id="personName">
                            <option value="">Select person</option>
                            <option value="Daril">Daril</option>
                            <option value="Arez">Arez</option>
                            <option value="Fawwaz">Fawwaz</option>
                            <option value="Panji">Panji</option>
                            <option value="Other">Other (Custom)</option>
                        </select>
                    </div>
                    <div class="form-group" id="customPersonGroup" style="display: none;">
                        <label for="customPersonName">Custom Name *</label>
                        <input type="text" id="customPersonName" placeholder="Enter custom name">
                    </div>
                    <div class="form-group">
                        <label for="personHargaIDR">Harga IDR *</label>
                        <input type="text" id="personHargaIDR" placeholder="e.g., 1908500">
                    </div>
                    <div class="form-group">
                        <label for="personTanggal">Tanggal Pengiriman *</label>
                        <input type="date" id="personTanggal">
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn-primary" onclick="app.addPerson()">Add Person</button>
                    <button class="btn-secondary" onclick="app.resetPersonForm()">Clear</button>
                </div>
            </div>

            <div class="table-wrapper">
                <div class="table-header">
                    <div class="table-title">Profit Per Person</div>
                </div>
                <table id="peopleTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Person</th>
                            <th>Harga IDR</th>
                            <th>Harga CNY</th>
                            <th>Tanggal Pengiriman</th>
                            <th>Profit Per Person (CNY)</th>
                            <th>Profit Per Person (IDR)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="peopleTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Edit Inventory Item</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="editSkinName">Skin Name *</label>
                    <input type="text" id="editSkinName">
                </div>
                <div class="form-group">
                    <label for="editCondition">Condition</label>
                    <select id="editCondition">
                        <option value="">Select condition (optional)</option>
                        <option value="Factory New">Factory New</option>
                        <option value="Minimal Wear">Minimal Wear</option>
                        <option value="Field-Tested">Field-Tested</option>
                        <option value="Well-Worn">Well-Worn</option>
                        <option value="Battle-Scarred">Battle-Scarred</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editBuyPriceIDR">Buy Price (IDR) *</label>
                    <input type="text" id="editBuyPriceIDR">
                </div>
                <div class="form-group">
                    <label for="editYouPinPrice">Current YouPin Price *</label>
                    <input type="text" id="editYouPinPrice">
                </div>
                <div class="form-group">
                    <label for="editSalePriceOverride">Sale Price (Override)</label>
                    <input type="text" id="editSalePriceOverride" placeholder="Auto-calculated if empty">
                </div>
                <div class="form-group">
                    <label for="editBuyDate">Buy Date (Optional)</label>
                    <input type="date" id="editBuyDate">
                </div>
                <div class="form-group">
                    <label for="editSellDate">Sell Date (Optional)</label>
                    <input type="date" id="editSellDate">
                </div>
                <div class="form-group">
                    <label for="editItemStatus">Status</label>
                    <select id="editItemStatus">
                        <option value="in-stock">In Stock</option>
                        <option value="sold">Sold</option>
                        <option value="not-tradable">Not Tradable</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editItemMethod">Method</label>
                    <select id="editItemMethod">
                        <option value="Pricempire">Pricempire</option>
                        <option value="Cashout">Cashout</option>
                    </select>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="editItemNote">Note (Optional)</label>
                    <input type="text" id="editItemNote" placeholder="Add any notes here...">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="app.saveEdit()">Save Changes</button>
                <button class="btn-secondary" onclick="app.closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Cycle Management Modal -->
    <div id="cycleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Manage Cycles</div>
            <div id="cycleListContainer" style="max-height: 400px; overflow-y: auto;"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="app.closeCycleModal()">Close</button>
            </div>
        </div>
    </div>

    </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>    
        const auth = {
            passwordHash: '86c8487e0bd9542f523bf1fee228a0dbe1827981bdcaeb628da95ce18c58254d', // CHANGE THIS
            inactivityTimer: null,
            inactivityDuration: 30 * 60 * 1000, // 30 minutes in milliseconds
            
            // Initialize authentication on page load
            init() {
                // Check if user is already authenticated in this session
                const isAuthenticated = sessionStorage.getItem('pasarskin_auth') === 'true';
                
                if (isAuthenticated && this.verifySession()) {
                    this.unlockApp();
                } else {
                    this.showLogin();
                }
            },
            
            // Verify session is valid
            verifySession() {
                const authTime = sessionStorage.getItem('pasarskin_auth_time');
                if (!authTime) return false;
                
                // Session expires after 24 hours
                const sessionDuration = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
                const now = new Date().getTime();
                
                if (now - parseInt(authTime) > sessionDuration) {
                    // Session expired
                    sessionStorage.removeItem('pasarskin_auth');
                    sessionStorage.removeItem('pasarskin_auth_time');
                    return false;
                }
                
                return true;
            },
            
            // Hash password using SHA-256
            async hashPassword(password) {
                const msgBuffer = new TextEncoder().encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            },
            
            // Login function
            async login() {
                const passwordInput = document.getElementById('passwordInput');
                const password = passwordInput.value;
                const errorEl = document.getElementById('loginError');
                
                if (!password) {
                    errorEl.classList.add('show');
                    errorEl.textContent = 'Please enter a password';
                    return;
                }
                
                // Hash the entered password
                const enteredHash = await this.hashPassword(password);
                
                // Compare with stored hash
                if (enteredHash === this.passwordHash) {
                    // Correct password
                    sessionStorage.setItem('pasarskin_auth', 'true');
                    sessionStorage.setItem('pasarskin_auth_time', new Date().getTime().toString());
                    this.unlockApp();
                } else {
                    // Wrong password
                    errorEl.classList.add('show');
                    errorEl.textContent = 'Incorrect password. Please try again.';
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            },
            
            // Unlock and show the app
            async unlockApp() {
                try {
                    // Show loading screen
                    const loadingScreen = document.getElementById('loadingScreen');
                    const loginScreen = document.getElementById('loginScreen');
                    const appContainer = document.getElementById('appContainer');
                    const logoutBtn = document.getElementById('logoutBtn');
                    
                    loadingScreen.classList.remove('hidden');
                    loginScreen.classList.add('hidden');
                    
                    // Set a maximum timeout to prevent infinite loading
                    const timeoutId = setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                        appContainer.classList.add('unlocked');
                        logoutBtn.style.display = 'block';
                    }, 5000); // 5 second timeout
                    
                    // Initialize the app and wait for data to load
                    if (typeof app !== 'undefined') {
                        await app.init();
                    }
                    
                    // Clear timeout if we finished before it
                    clearTimeout(timeoutId);
                    
                    // Hide loading screen and show app
                    loadingScreen.classList.add('hidden');
                    appContainer.classList.add('unlocked');
                    logoutBtn.style.display = 'block';
                    
                    // Start inactivity timer
                    this.startInactivityTimer();
                    this.setupActivityListeners();
                } catch (error) {
                    // Hide loading screen and show app anyway
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('appContainer').classList.add('unlocked');
                    document.getElementById('logoutBtn').style.display = 'block';
                    
                    // Start inactivity timer
                    this.startInactivityTimer();
                    this.setupActivityListeners();
                }
            },
            
            // Show login screen
            showLogin() {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appContainer').classList.remove('unlocked');
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('passwordInput').focus();
            },
            
            // Logout function
            logout(auto = false) {
                const message = auto ? 
                    'You have been logged out due to inactivity.' : 
                    'Are you sure you want to logout?';
                    
                if (auto || confirm(message)) {
                    sessionStorage.removeItem('pasarskin_auth');
                    sessionStorage.removeItem('pasarskin_auth_time');
                    this.stopInactivityTimer();
                    this.removeActivityListeners();
                    
                    if (auto) {
                        // Auto logout - refresh the page
                        alert(message);
                        window.location.reload();
                    } else {
                        this.showLogin();
                        
                        // Clear password input
                        document.getElementById('passwordInput').value = '';
                        document.getElementById('loginError').classList.remove('show');
                    }
                }
            },
            
            // Start inactivity timer
            startInactivityTimer() {
                this.resetInactivityTimer();
            },
            
            // Reset inactivity timer
            resetInactivityTimer() {
                // Clear existing timer
                if (this.inactivityTimer) {
                    clearTimeout(this.inactivityTimer);
                }
                
                // Set new timer
                this.inactivityTimer = setTimeout(() => {
                    this.logout(true);
                }, this.inactivityDuration);
            },
            
            // Stop inactivity timer
            stopInactivityTimer() {
                if (this.inactivityTimer) {
                    clearTimeout(this.inactivityTimer);
                    this.inactivityTimer = null;
                }
            },
            
            // Setup activity listeners
            setupActivityListeners() {
                const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
                events.forEach(event => {
                    document.addEventListener(event, this.handleActivity.bind(this), true);
                });
            },
            
            // Remove activity listeners
            removeActivityListeners() {
                const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
                events.forEach(event => {
                    document.removeEventListener(event, this.handleActivity.bind(this), true);
                });
            },
            
            // Handle user activity
            handleActivity() {
                this.resetInactivityTimer();
            }
        };
        
        // Initialize authentication on page load
        auth.init();

        // Firebase Configuration
        // IMPORTANT: Replace this with your own Firebase config
        // Go to https://console.firebase.google.com/ to create a project and get your config
        const firebaseConfig = {
        apiKey: "AIzaSyDHa93cpbY0Wh7IEymcVV2bqZRfKrahdkc",
        authDomain: "pasar-skin-tracker.firebaseapp.com",
        databaseURL: "https://pasar-skin-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pasar-skin-tracker",
        storageBucket: "pasar-skin-tracker.firebasestorage.app",
        messagingSenderId: "865539013174",
        appId: "1:865539013174:web:48d664d844c125b6f1b697"
        };

        // Initialize Firebase only if config is set
        let database = null;
        let isFirebaseEnabled = false;
        
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseEnabled = true;
            }
        } catch (error) {
            isFirebaseEnabled = false;
        }

        const app = {
            // Cycle management
            cycles: {
                1: {
                    name: 'Cycle 1',
                    data: [
                        { no: 1, name: "Driver Gloves | Overtake", condition: "Battle-Scarred", priceIDR: 950000, priceCNY: 395.83, currentYouPin: 448.00, salePrice: 443.52, profit: 47.69, profitMargin: 12.05, sold: false, buyDate: "", sellDate: "", method: "Pricempire", note: "" },
                        { no: 2, name: "Kukri Knife | Safari Mesh", condition: "Well-Worn", priceIDR: 760000, priceCNY: 316.67, currentYouPin: 370.89, salePrice: 368.43, profit: 51.76, profitMargin: 16.35, sold: false, buyDate: "", sellDate: "", method: "Pricempire", note: "" },
                    ],
                    peopleData: [
                        { no: 1, person: "Daril", hargaIDR: 1908500, hargaCNY: 795.21, tanggalPengiriman: "2026-01-01", profitCNY: 198.80, profitIDR: 476928 },
                        { no: 2, person: "Arez", hargaIDR: 1908500, hargaCNY: 795.21, tanggalPengiriman: "2026-01-01", profitCNY: 198.80, profitIDR: 476928 },
                        { no: 3, person: "Fawwaz", hargaIDR: 1908500, hargaCNY: 795.21, tanggalPengiriman: "2026-01-01", profitCNY: 198.80, profitIDR: 476928 },
                        { no: 4, person: "Panji", hargaIDR: 1908500, hargaCNY: 795.21, tanggalPengiriman: "2026-01-01", profitCNY: 198.80, profitIDR: 476928 }
                    ]
                }
            },
            currentCycle: 1,
            
            // Quick access to current cycle data
            get data() {
                return this.cycles[this.currentCycle]?.data || [];
            },
            set data(value) {
                if (!this.cycles[this.currentCycle]) {
                    this.cycles[this.currentCycle] = { name: `Cycle ${this.currentCycle}`, data: [], peopleData: [] };
                }
                this.cycles[this.currentCycle].data = value;
            },
            get peopleData() {
                return this.cycles[this.currentCycle]?.peopleData || [];
            },
            set peopleData(value) {
                if (!this.cycles[this.currentCycle]) {
                    this.cycles[this.currentCycle] = { name: `Cycle ${this.currentCycle}`, data: [], peopleData: [] };
                }
                this.cycles[this.currentCycle].peopleData = value;
            },
            
            exchangeRate: 2400, // IDR to CNY conversion rate (approximate)

            currentFilter: 'all',
            currentTab: 'inventory',
            viewMode: 'simple', // 'simple' or 'complete'
            editingIndex: null,

            async init() {
                try {
                    this.attachSearchListener();
                    this.updateStorageStatus();
                    
                    if (isFirebaseEnabled) {
                        // Wait for Firebase data to load before continuing
                        await this.loadFromFirebase();
                        this.setupRealtimeListeners();
                    } else {
                        this.loadFromLocalStorage();
                        this.renderAll();
                    }
                    
                    // Ensure at least one cycle exists
                    if (Object.keys(this.cycles).length === 0) {
                        this.cycles[1] = {
                            name: 'Cycle 1',
                            data: [],
                            peopleData: []
                        };
                        this.currentCycle = 1;
                        this.saveToFirebase();
                    }
                    
                    this.renderCycleSelector();
                } catch (error) {
                    // If there's an error, create default cycle
                    if (Object.keys(this.cycles).length === 0) {
                        this.cycles[1] = {
                            name: 'Cycle 1',
                            data: [],
                            peopleData: []
                        };
                        this.currentCycle = 1;
                    }
                    this.renderCycleSelector();
                    this.renderAll();
                }
            },

            updateStorageStatus() {
                const statusEl = document.getElementById('storageStatus');
                if (isFirebaseEnabled) {
                    statusEl.innerHTML = 'ðŸŸ¢ Connected to Cloud Storage - Data synced across all users';
                    statusEl.style.color = '#10b981';
                } else {
                    statusEl.innerHTML = 'ðŸŸ¡ Using Local Storage - Data saved only on this device';
                    statusEl.style.color = '#f59e0b';
                }
            },

            renderAll() {
                this.renderMetrics();
                this.renderInventory();
                this.renderSummary();
                this.renderPeople();
            },

            loadFromLocalStorage() {
                try {
                    const savedData = localStorage.getItem('pasarSkinData');
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        // Support both old and new format
                        if (parsed.cycles) {
                            this.cycles = parsed.cycles;
                            this.currentCycle = parsed.currentCycle || 1;
                        } else if (parsed.data) {
                            // Migrate old format to new cycle format
                            this.cycles[1] = {
                                name: 'Cycle 1',
                                data: parsed.data || [],
                                peopleData: parsed.peopleData || []
                            };
                        }
                        if (parsed.exchangeRate) this.exchangeRate = parsed.exchangeRate;
                    }
                } catch (error) {
                    // Silent fail
                }
            },

            saveToLocalStorage() {
                try {
                    const dataToSave = {
                        cycles: this.cycles,
                        currentCycle: this.currentCycle,
                        exchangeRate: this.exchangeRate
                    };
                    localStorage.setItem('pasarSkinData', JSON.stringify(dataToSave));
                } catch (error) {
                    // Silent fail
                }
            },

            loadFromFirebase() {
                const ref = database.ref('pasarSkinInventory');
                return ref.once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            // Support both old and new format
                            if (data.cycles) {
                                this.cycles = data.cycles;
                                this.currentCycle = data.currentCycle || 1;
                            } else if (data.data) {
                                // Migrate old format to new cycle format
                                this.cycles[1] = {
                                    name: 'Cycle 1',
                                    data: data.data || [],
                                    peopleData: data.peopleData || []
                                };
                            }
                            if (data.exchangeRate) this.exchangeRate = data.exchangeRate;
                        }
                        this.renderCycleSelector();
                        this.renderAll();
                    })
                    .catch((error) => {
                        this.renderAll();
                    });
            },

            saveToFirebase() {
                if (!isFirebaseEnabled) {
                    this.saveToLocalStorage();
                    return;
                }
                
                const dataToSave = {
                    cycles: this.cycles,
                    currentCycle: this.currentCycle,
                    exchangeRate: this.exchangeRate,
                    lastUpdated: new Date().toISOString()
                };
                
                database.ref('pasarSkinInventory').set(dataToSave)
                    .then(() => {
                        // Success
                    })
                    .catch((error) => {
                        alert('Failed to save data to cloud. Please try again.');
                    });
            },

            setupRealtimeListeners() {
                const ref = database.ref('pasarSkinInventory');
                ref.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Support both old and new format
                        if (data.cycles) {
                            this.cycles = data.cycles;
                            this.currentCycle = data.currentCycle || 1;
                        } else if (data.data) {
                            // Migrate old format
                            this.cycles[1] = {
                                name: 'Cycle 1',
                                data: data.data || [],
                                peopleData: data.peopleData || []
                            };
                        }
                        if (data.exchangeRate) this.exchangeRate = data.exchangeRate;
                        this.renderCycleSelector();
                        this.renderAll();
                    }
                });
            },

            calculatePriceCNY(priceIDR) {
                return priceIDR / this.exchangeRate;
            },

            calculateSalePrice(youPinPrice) {
                return youPinPrice * 0.99;
            },

            calculateSalePriceIDR(salePriceCNY) {
                return salePriceCNY * this.exchangeRate;
            },

            calculateProfit(salePrice, priceCNY) {
                return salePrice - priceCNY;
            },

            calculateProfitMargin(profit, priceCNY) {
                if (priceCNY === 0) return 0;
                return (profit / priceCNY) * 100;
            },

            addItem() {
                const skinName = document.getElementById('skinName').value.trim();
                const condition = document.getElementById('condition').value;
                const buyPriceIDR = parseFloat(document.getElementById('buyPriceIDR').value);
                const youPinPrice = parseFloat(document.getElementById('youPinPrice').value);
                const salePriceOverride = document.getElementById('salePriceOverride').value.trim();
                const buyDate = document.getElementById('buyDate').value;
                const sellDate = document.getElementById('sellDate').value;
                const itemStatus = document.getElementById('itemStatus').value;
                const itemMethod = document.getElementById('itemMethod').value;
                const itemNote = document.getElementById('itemNote').value.trim();

                // Validation
                if (!skinName) {
                    alert('Please enter a skin name');
                    return;
                }
                if (isNaN(buyPriceIDR) || buyPriceIDR <= 0) {
                    alert('Please enter a valid buy price in IDR');
                    return;
                }
                if (isNaN(youPinPrice) || youPinPrice <= 0) {
                    alert('Please enter a valid YouPin price');
                    return;
                }

                // Calculations
                const priceCNY = this.calculatePriceCNY(buyPriceIDR);
                // Use manual sale price if provided, otherwise calculate
                const salePrice = salePriceOverride && !isNaN(parseFloat(salePriceOverride)) 
                    ? parseFloat(salePriceOverride) 
                    : this.calculateSalePrice(youPinPrice);
                const profit = this.calculateProfit(salePrice, priceCNY);
                const profitMargin = this.calculateProfitMargin(profit, priceCNY);

                // Create new item object
                const newItem = {
                    no: this.data.length + 1,
                    name: skinName,
                    condition: condition || 'N/A',
                    priceIDR: buyPriceIDR,
                    priceCNY: priceCNY,
                    currentYouPin: youPinPrice,
                    salePrice: salePrice,
                    profit: profit,
                    profitMargin: profitMargin,
                    sold: itemStatus === 'sold',
                    status: itemStatus,
                    buyDate: buyDate || '',
                    sellDate: sellDate || '',
                    method: itemMethod || 'Pricempire',
                    note: itemNote || ''
                };

                // Add to data
                this.data.push(newItem);

                // Save to Firebase or localStorage
                this.saveToFirebase();

                // Reset form and update UI
                this.resetForm();
                if (!isFirebaseEnabled) {
                    this.renderMetrics();
                    this.renderInventory();
                    this.renderPeople();
                }
            },

            resetForm() {
                document.getElementById('skinName').value = '';
                document.getElementById('condition').value = '';
                document.getElementById('buyPriceIDR').value = '';
                document.getElementById('youPinPrice').value = '';
                document.getElementById('salePriceOverride').value = '';
                document.getElementById('buyDate').value = '';
                document.getElementById('sellDate').value = '';
                document.getElementById('itemStatus').value = 'in-stock';
                document.getElementById('itemMethod').value = 'Pricempire';
                document.getElementById('itemNote').value = '';
                document.getElementById('formPreview').classList.remove('show');
            },

            openEditModal(index) {
                this.editingIndex = index;
                const item = this.data[index];
                
                document.getElementById('editSkinName').value = item.name;
                document.getElementById('editCondition').value = item.condition === 'N/A' ? '' : item.condition;
                document.getElementById('editBuyPriceIDR').value = item.priceIDR;
                document.getElementById('editYouPinPrice').value = item.currentYouPin;
                document.getElementById('editSalePriceOverride').value = item.salePrice || '';
                document.getElementById('editBuyDate').value = item.buyDate || '';
                document.getElementById('editSellDate').value = item.sellDate || '';
                // Backward compatibility: check both status field and sold boolean
                const itemStatus = item.status || (item.sold ? 'sold' : 'in-stock');
                document.getElementById('editItemStatus').value = itemStatus;
                document.getElementById('editItemMethod').value = item.method || 'Pricempire';
                document.getElementById('editItemNote').value = item.note || '';
                
                document.getElementById('editModal').classList.add('show');
            },

            closeEditModal() {
                document.getElementById('editModal').classList.remove('show');
                this.editingIndex = null;
            },

            saveEdit() {
                if (this.editingIndex === null) return;

                const skinName = document.getElementById('editSkinName').value.trim();
                const condition = document.getElementById('editCondition').value;
                const buyPriceIDR = parseFloat(document.getElementById('editBuyPriceIDR').value);
                const youPinPrice = parseFloat(document.getElementById('editYouPinPrice').value);
                const salePriceOverride = document.getElementById('editSalePriceOverride').value.trim();
                const buyDate = document.getElementById('editBuyDate').value;
                const sellDate = document.getElementById('editSellDate').value;
                const itemStatus = document.getElementById('editItemStatus').value;
                const itemMethod = document.getElementById('editItemMethod').value;
                const itemNote = document.getElementById('editItemNote').value.trim();

                // Validation
                if (!skinName) {
                    alert('Please enter a skin name');
                    return;
                }
                if (isNaN(buyPriceIDR) || buyPriceIDR <= 0) {
                    alert('Please enter a valid buy price in IDR');
                    return;
                }
                if (isNaN(youPinPrice) || youPinPrice <= 0) {
                    alert('Please enter a valid YouPin price');
                    return;
                }

                // Calculations
                const priceCNY = this.calculatePriceCNY(buyPriceIDR);
                // Use manual sale price if provided, otherwise calculate
                const salePrice = salePriceOverride && !isNaN(parseFloat(salePriceOverride)) 
                    ? parseFloat(salePriceOverride) 
                    : this.calculateSalePrice(youPinPrice);
                const profit = this.calculateProfit(salePrice, priceCNY);
                const profitMargin = this.calculateProfitMargin(profit, priceCNY);

                // Update item
                this.data[this.editingIndex] = {
                    ...this.data[this.editingIndex],
                    name: skinName,
                    condition: condition || 'N/A',
                    priceIDR: buyPriceIDR,
                    priceCNY: priceCNY,
                    currentYouPin: youPinPrice,
                    salePrice: salePrice,
                    profit: profit,
                    profitMargin: profitMargin,
                    sold: itemStatus === 'sold',
                    status: itemStatus,
                    buyDate: buyDate || '',
                    sellDate: sellDate || '',
                    method: itemMethod || 'Pricempire',
                    note: itemNote || ''
                };

                // Save to Firebase or localStorage
                this.saveToFirebase();

                // Close modal and update UI
                this.closeEditModal();
                if (!isFirebaseEnabled) {
                    this.renderMetrics();
                    this.renderInventory();
                    this.renderPeople();
                }
            },

            deleteItem(index) {
                if (confirm('Are you sure you want to delete this item?')) {
                    this.data.splice(index, 1);
                    this.data.forEach((item, idx) => item.no = idx + 1); // Reassign item numbers
                    
                    // Save to Firebase or localStorage
                    this.saveToFirebase();
                    
                    if (!isFirebaseEnabled) {
                        this.renderMetrics();
                        this.renderInventory();
                        this.renderPeople();
                    }
                }
            },

            exportToJSON() {
                const cycleData = this.cycles[this.currentCycle];
                if (!cycleData) {
                    alert('No data available for the selected cycle.');
                    return;
                }

                const dataStr = JSON.stringify({ [this.currentCycle]: cycleData }, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `cycle_${this.currentCycle}.json`;
                a.click();
                URL.revokeObjectURL(url);

                alert(`Cycle ${this.currentCycle} data exported successfully!`);
            },

            importFromJSON(event) {
                const file = event.target.files[0];
                if (!file) {
                    alert('No file selected.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        for (const [cycleId, cycleContent] of Object.entries(importedData)) {
                            if (!this.cycles[cycleId]) {
                                this.cycles[cycleId] = cycleContent;
                            } else {
                                alert(`Cycle ${cycleId} already exists and was not overwritten.`);
                            }
                        }
                        this.saveToLocalStorage();
                        this.renderAll();
                        alert('Cycle data imported successfully!');
                    } catch (error) {
                        alert('Invalid JSON file. Please check the file and try again.');
                    }
                };
                reader.readAsText(file);

                document.getElementById('importFile').value = '';
            },

            renderMetrics() {
                const totalInvestmentCNY = this.data.reduce((sum, item) => sum + item.priceCNY, 0);
                const totalCurrentValueCNY = this.data.reduce((sum, item) => sum + item.currentYouPin, 0);
                const totalProfit = this.data.reduce((sum, item) => sum + item.profit, 0);
                const avgProfitMargin = this.data.length > 0 ? (this.data.reduce((sum, item) => sum + item.profitMargin, 0) / this.data.length) : 0;

                const metrics = [
                    {
                        label: "Total Investment",
                        value: `Â¥${totalInvestmentCNY.toFixed(2)}`,
                        change: `${(totalInvestmentCNY * this.exchangeRate).toLocaleString('id-ID')} IDR`,
                        positive: false
                    },
                    {
                        label: "Total Items",
                        value: `${this.data.length}`,
                        change: "Inventory items",
                        positive: true
                    },
                    {
                        label: "Total Profit (After Tax)",
                        value: `Â¥${totalProfit.toFixed(2)}`,
                        change: `${avgProfitMargin.toFixed(2)}% Avg Profit Margin`,
                        positive: totalProfit > 0
                    },
                    {
                        label: "Profit Margin",
                        value: `${((totalProfit / totalInvestmentCNY) * 100).toFixed(2)}%`,
                        change: `${this.data.length} items`,
                        positive: avgProfitMargin > 0
                    }
                ];

                const container = document.getElementById('metricsContainer');
                container.innerHTML = metrics.map(metric => `
                    <div class="metric-card">
                        <div class="metric-label">${metric.label}</div>
                        <div class="metric-value ${metric.positive ? 'metric-positive' : 'metric-negative'}">${metric.value}</div>
                        <div class="metric-change">${metric.change}</div>
                    </div>
                `).join('');
            },

            renderInventory() {
                const inventoryContainer = document.getElementById('inventoryTab');
                const filteredData = this.getFilteredData();

                let tableHTML;
                
                if (this.viewMode === 'simple') {
                    // Simple view - basic columns only
                    const rows = filteredData.map((item, index) => {
                        let statusText = 'In Stock';
                        if (item.sold || item.status === 'sold') {
                            statusText = 'Sold';
                        } else if (item.status === 'not-tradable') {
                            statusText = 'Not Tradable';
                        }
                        
                        return `
                            <tr>
                                <td>${item.no}</td>
                                <td class="item-name">${item.name}</td>
                                <td>${item.condition}</td>
                                <td>${item.priceIDR.toLocaleString()}</td>
                                <td>${item.priceCNY.toFixed(2)}</td>
                                <td>${item.currentYouPin.toFixed(2)}</td>
                                <td>${item.salePrice.toFixed(2)}</td>
                                <td class="${item.profit >= 0 ? 'positive' : 'negative'}">${item.profit.toFixed(2)}</td>
                                <td class="${item.profitMargin >= 0 ? 'positive' : 'negative'}">${item.profitMargin.toFixed(2)}%</td>
                                <td>${statusText}</td>
                                <td>
                                    <button class="edit-btn" onclick="app.openEditModal(${index})">Edit</button>
                                    <button class="delete-btn" onclick="app.deleteItem(${index})">Delete</button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    tableHTML = `
                        <div class="table-wrapper">
                            <div class="table-header">
                                <div class="table-title">Current Inventory - Simple View</div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Skin Name</th>
                                        <th>Condition</th>
                                        <th>Buy Price (IDR)</th>
                                        <th>Buy Price (CNY)</th>
                                        <th>Current YouPin (CNY)</th>
                                        <th>Sale Price (CNY)</th>
                                        <th>Profit (CNY)</th>
                                        <th>Profit Margin</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows || '<tr><td colspan="11" class="no-data">No inventory data available</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    // Complete view - all columns including dates and Sale Price IDR
                    const rows = filteredData.map((item, index) => {
                        const salePriceIDR = this.calculateSalePriceIDR(item.salePrice);
                        let statusText = 'In Stock';
                        if (item.sold || item.status === 'sold') {
                            statusText = 'Sold';
                        } else if (item.status === 'not-tradable') {
                            statusText = 'Not Tradable';
                        }
                        
                        return `
                            <tr>
                                <td>${item.no}</td>
                                <td class="item-name">${item.name}</td>
                                <td>${item.condition}</td>
                                <td>${item.priceIDR.toLocaleString()}</td>
                                <td>${item.priceCNY.toFixed(2)}</td>
                                <td>${item.currentYouPin.toFixed(2)}</td>
                                <td>${item.salePrice.toFixed(2)}</td>
                                <td>${salePriceIDR.toLocaleString()}</td>
                                <td class="${item.profit >= 0 ? 'positive' : 'negative'}">${item.profit.toFixed(2)}</td>
                                <td class="${item.profitMargin >= 0 ? 'positive' : 'negative'}">${item.profitMargin.toFixed(2)}%</td>
                                <td>${item.buyDate || '-'}</td>
                                <td>${item.sellDate || '-'}</td>
                                <td>${item.method || 'Pricempire'}</td>
                                <td>${statusText}</td>
                                <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${item.note || '-'}</td>
                                <td>
                                    <button class="edit-btn" onclick="app.openEditModal(${index})">Edit</button>
                                    <button class="delete-btn" onclick="app.deleteItem(${index})">Delete</button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    tableHTML = `
                        <div class="table-wrapper">
                            <div class="table-header">
                                <div class="table-title">Current Inventory - Complete View</div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Skin Name</th>
                                        <th>Condition</th>
                                        <th>Buy Price (IDR)</th>
                                        <th>Buy Price (CNY)</th>
                                        <th>Current YouPin (CNY)</th>
                                        <th>Sale Price (CNY)</th>
                                        <th>Sale Price (IDR)</th>
                                        <th>Profit (CNY)</th>
                                        <th>Profit Margin</th>
                                        <th>Buy Date</th>
                                        <th>Sell Date</th>
                                        <th>Method</th>
                                        <th>Status</th>
                                        <th>Note</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows || '<tr><td colspan="16" class="no-data">No inventory data available</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                inventoryContainer.innerHTML = tableHTML;
            },

            switchViewMode(mode) {
                this.viewMode = mode;
                document.getElementById('viewSimple').classList.toggle('active', mode === 'simple');
                document.getElementById('viewComplete').classList.toggle('active', mode === 'complete');
                this.renderInventory();
            },

            renderSummary() {
                const tbody = document.getElementById('summaryTableBody');
                
                // Calculate per-cycle summary from all cycles
                const cycleEntries = Object.entries(this.cycles);
                
                if (cycleEntries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-data">No cycles available</td></tr>';
                    return;
                }
                
                const cycleRows = cycleEntries.map(([cycleId, cycle]) => {
                    const cycleData = cycle.data || [];
                    const totalInvestmentIDR = cycleData.reduce((sum, item) => sum + (item.priceIDR || 0), 0);
                    const totalInvestmentCNY = cycleData.reduce((sum, item) => sum + (item.priceCNY || 0), 0);
                    const totalProfit = cycleData.reduce((sum, item) => sum + (item.profit || 0), 0);
                    const profitPercent = totalInvestmentCNY > 0 ? (totalProfit / totalInvestmentCNY * 100) : 0;
                    const totalRevenue = totalInvestmentIDR + (totalProfit * this.exchangeRate);
                    
                    return `
                        <tr style="${cycleId == this.currentCycle ? 'background: rgba(59, 130, 246, 0.1);' : ''}">
                            <td>${cycle.name || `Cycle ${cycleId}`}</td>
                            <td>${cycleData.length} items</td>
                            <td>${totalInvestmentIDR.toLocaleString('id-ID')}</td>
                            <td>Â¥${totalInvestmentCNY.toFixed(2)}</td>
                            <td class="${profitPercent >= 0 ? 'positive' : 'negative'}">${profitPercent.toFixed(2)}%</td>
                            <td>${totalRevenue.toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                }).join('');
                
                tbody.innerHTML = cycleRows || '<tr><td colspan="6" class="no-data">No cycle data available</td></tr>';
            },

            renderPeople() {
                const tbody = document.getElementById('peopleTableBody');
                
                if (this.peopleData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="no-data">No people entries yet. Add your first entry above!</td></tr>';
                    return;
                }
                
                // Calculate total profit from CURRENT CYCLE inventory only
                const totalInventoryProfit = this.data.reduce((sum, item) => sum + item.profit, 0);
                
                // Calculate total capital invested by all people
                const totalCapitalCNY = this.peopleData.reduce((sum, person) => {
                    const capital = person.hargaCNY || person.investmentCNY || 0;
                    return sum + capital;
                }, 0);
                const totalCapitalIDR = this.peopleData.reduce((sum, person) => {
                    const capital = person.hargaIDR || person.investmentIDR || 0;
                    return sum + capital;
                }, 0);
                
                // Calculate total inventory cost (actual money spent)
                const totalInventoryCostCNY = this.data.reduce((sum, item) => sum + item.priceCNY, 0);
                const totalInventoryCostIDR = this.data.reduce((sum, item) => sum + item.priceIDR, 0);
                
                // Calculate leftover (SISA) - capital that wasn't spent on inventory
                const leftoverCNY = totalCapitalCNY - totalInventoryCostCNY;
                const leftoverIDR = totalCapitalIDR - totalInventoryCostIDR;
                
                const html = this.peopleData.map((person, index) => {
                    // Handle both old and new data formats
                    const no = person.no || (index + 1);
                    const name = person.person || 'Unknown';
                    const hargaIDR = person.hargaIDR || person.investmentIDR || 0;
                    const hargaCNY = person.hargaCNY || person.investmentCNY || 0;
                    const tanggal = person.tanggalPengiriman || person.month || '-';
                    
                    // Calculate profit per person PROPORTIONALLY based on capital invested
                    // Each person gets profit proportional to their capital contribution
                    let profitCNY = 0;
                    let leftoverShareCNY = 0;
                    if (totalCapitalCNY > 0) {
                        const capitalShare = hargaCNY / totalCapitalCNY; // Person's percentage of total capital
                        profitCNY = totalInventoryProfit * capitalShare;
                        leftoverShareCNY = leftoverCNY * capitalShare; // Person's share of leftover
                    }
                    
                    // Total profit = inventory profit + leftover share
                    const totalProfitCNY = profitCNY + leftoverShareCNY;
                    const profitIDR = profitCNY * this.exchangeRate;
                    const leftoverShareIDR = leftoverShareCNY * this.exchangeRate;
                    const totalProfitIDR = totalProfitCNY * this.exchangeRate;
                    
                    return `
                        <tr>
                            <td>${no}</td>
                            <td>${name}</td>
                            <td>${hargaIDR.toLocaleString('id-ID')}</td>
                            <td>Â¥${hargaCNY.toFixed(2)}</td>
                            <td>${tanggal}</td>
                            <td class="${totalProfitCNY >= 0 ? 'positive' : 'negative'}">Â¥${totalProfitCNY.toFixed(2)}</td>
                            <td class="${totalProfitIDR >= 0 ? 'positive' : 'negative'}">${totalProfitIDR.toLocaleString('id-ID')}</td>
                            <td>
                                <button class="edit-btn" onclick="app.editPerson(${index})">Edit</button>
                                <button class="delete-btn" onclick="app.deletePerson(${index})">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                tbody.innerHTML = html;
            },

            addPerson() {
                let personName = document.getElementById('personName').value;
                const customName = document.getElementById('customPersonName').value.trim();
                const hargaIDRInput = document.getElementById('personHargaIDR').value;
                const tanggal = document.getElementById('personTanggal').value;

                // If "Other" is selected, use custom name
                if (personName === 'Other' && customName) {
                    personName = customName;
                } else if (personName === 'Other' && !customName) {
                    alert('Please enter a custom name');
                    return;
                }

                // Validation
                if (!personName || personName === '') {
                    alert('Please select a person');
                    return;
                }

                const hargaIDR = parseFloat(hargaIDRInput.replace(/[^0-9.]/g, ''));
                if (isNaN(hargaIDR) || hargaIDR <= 0) {
                    alert('Please enter a valid Harga IDR (numbers only)');
                    return;
                }
                if (!tanggal) {
                    alert('Please select a date');
                    return;
                }

                // Calculate values
                const hargaCNY = hargaIDR / this.exchangeRate;
                const totalProfit = this.data.reduce((sum, item) => sum + item.profit, 0);
                
                // Calculate total capital (including the new person's contribution)
                const existingCapitalCNY = this.peopleData.reduce((sum, person) => {
                    return sum + (person.hargaCNY || person.investmentCNY || 0);
                }, 0);
                const existingCapitalIDR = this.peopleData.reduce((sum, person) => {
                    return sum + (person.hargaIDR || person.investmentIDR || 0);
                }, 0);
                const totalCapitalCNY = existingCapitalCNY + hargaCNY;
                const totalCapitalIDR = existingCapitalIDR + hargaIDR;
                
                // Calculate leftover (SISA)
                const totalInventoryCostCNY = this.data.reduce((sum, item) => sum + item.priceCNY, 0);
                const totalInventoryCostIDR = this.data.reduce((sum, item) => sum + item.priceIDR, 0);
                const leftoverCNY = totalCapitalCNY - totalInventoryCostCNY;
                
                // Calculate proportional profit for new person (including leftover share)
                const capitalShare = hargaCNY / totalCapitalCNY;
                const inventoryProfitCNY = totalProfit * capitalShare;
                const leftoverShareCNY = leftoverCNY * capitalShare;
                const totalProfitCNY = inventoryProfitCNY + leftoverShareCNY;
                const totalProfitIDR = totalProfitCNY * this.exchangeRate;

                // Create new person entry
                const newPerson = {
                    no: this.peopleData.length + 1,
                    person: personName,
                    hargaIDR: hargaIDR,
                    hargaCNY: hargaCNY,
                    tanggalPengiriman: tanggal,
                    profitCNY: totalProfitCNY,
                    profitIDR: totalProfitIDR
                };

                this.peopleData.push(newPerson);
                
                // Save and render
                this.saveToFirebase();
                this.resetPersonForm();
                
                // Force render immediately (Firebase listener will update later)
                this.renderPeople();
            },

            resetPersonForm() {
                document.getElementById('personName').value = '';
                document.getElementById('customPersonName').value = '';
                document.getElementById('personHargaIDR').value = '';
                document.getElementById('personTanggal').value = '';
                document.getElementById('customPersonGroup').style.display = 'none';
            },

            editPerson(index) {
                const person = this.peopleData[index];
                const newName = prompt('Enter person name:', person.person);
                const newHargaIDR = prompt('Enter Harga IDR:', person.hargaIDR);
                const newTanggal = prompt('Enter Tanggal Pengiriman (YYYY-MM-DD):', person.tanggalPengiriman);

                let changed = false;

                if (newName !== null && newName.trim() !== '') {
                    this.peopleData[index].person = newName.trim();
                    changed = true;
                }
                
                if (newHargaIDR !== null && !isNaN(parseFloat(newHargaIDR))) {
                    const hargaIDR = parseFloat(newHargaIDR);
                    this.peopleData[index].hargaIDR = hargaIDR;
                    this.peopleData[index].hargaCNY = hargaIDR / this.exchangeRate;
                    
                    // Recalculate profit proportionally (including leftover)
                    const totalProfit = this.data.reduce((sum, item) => sum + item.profit, 0);
                    const totalCapitalCNY = this.peopleData.reduce((sum, person) => {
                        return sum + (person.hargaCNY || person.investmentCNY || 0);
                    }, 0);
                    const totalCapitalIDR = this.peopleData.reduce((sum, person) => {
                        return sum + (person.hargaIDR || person.investmentIDR || 0);
                    }, 0);
                    
                    // Calculate leftover
                    const totalInventoryCostCNY = this.data.reduce((sum, item) => sum + item.priceCNY, 0);
                    const leftoverCNY = totalCapitalCNY - totalInventoryCostCNY;
                    
                    if (totalCapitalCNY > 0) {
                        const capitalShare = this.peopleData[index].hargaCNY / totalCapitalCNY;
                        const inventoryProfitCNY = totalProfit * capitalShare;
                        const leftoverShareCNY = leftoverCNY * capitalShare;
                        const totalProfitCNY = inventoryProfitCNY + leftoverShareCNY;
                        this.peopleData[index].profitCNY = totalProfitCNY;
                        this.peopleData[index].profitIDR = totalProfitCNY * this.exchangeRate;
                    }
                    changed = true;
                }

                if (newTanggal !== null && newTanggal.trim() !== '') {
                    this.peopleData[index].tanggalPengiriman = newTanggal.trim();
                    changed = true;
                }

                if (changed) {
                    this.saveToFirebase();
                    this.renderPeople();
                }
            },

            deletePerson(index) {
                if (confirm('Are you sure you want to delete this person entry?')) {
                    this.peopleData.splice(index, 1);
                    // Reassign numbers
                    this.peopleData.forEach((person, idx) => person.no = idx + 1);
                    this.saveToFirebase();
                    this.renderPeople();
                }
            },

            renderSettingsModal() {
                // Remove existing settings modal if it exists
                const existingModal = document.getElementById('settingsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                const modalHTML = `
                    <div id="settingsModal" class="modal show">
                        <div class="modal-content">
                            <div class="modal-header">Settings</div>
                            <div class="form-group">
                                <label for="exchangeRateInput">Exchange Rate (IDR to CNY)</label>
                                <input type="number" id="exchangeRateInput" value="${this.exchangeRate}" class="login-input" step="0.01">
                            </div>
                            <div class="modal-actions">
                                <button class="btn-primary" onclick="app.saveSettings()">Save</button>
                                <button class="btn-secondary" onclick="app.closeSettingsModal()">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            },

            closeSettingsModal() {
                const modal = document.getElementById('settingsModal');
                if (modal) {
                    modal.remove();
                }
            },

            saveSettings() {
                const newExchangeRate = parseFloat(document.getElementById('exchangeRateInput').value);
                if (!isNaN(newExchangeRate) && newExchangeRate > 0) {
                    this.exchangeRate = newExchangeRate;
                    
                    // Recalculate all items with new exchange rate
                    Object.keys(this.cycles).forEach(cycleId => {
                        const cycle = this.cycles[cycleId];
                        if (cycle.data) {
                            cycle.data = cycle.data.map(item => {
                                const priceCNY = this.calculatePriceCNY(item.priceIDR);
                                const profit = this.calculateProfit(item.salePrice, priceCNY);
                                const profitMargin = this.calculateProfitMargin(profit, priceCNY);
                                return {
                                    ...item,
                                    priceCNY: priceCNY,
                                    profit: profit,
                                    profitMargin: profitMargin
                                };
                            });
                        }
                    });
                    
                    this.saveToFirebase();
                    this.renderAll();
                    alert('Settings saved successfully!');
                } else {
                    alert('Please enter a valid exchange rate.');
                }
                this.closeSettingsModal();
            },

            getFilteredData() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                
                let filtered = this.data.filter(item => {
                    const matchesSearch = item.name.toLowerCase().includes(searchTerm);
                    
                    if (this.currentFilter === 'all') return matchesSearch;
                    if (this.currentFilter === 'sold') return matchesSearch && item.sold;
                    if (this.currentFilter === 'active') return matchesSearch && !item.sold;
                    
                    return matchesSearch;
                });
                
                return filtered;
            },

            filterByStatus(status) {
                this.currentFilter = status;
                document.getElementById('filterAll').classList.toggle('active', status === 'all');
                document.getElementById('filterActive').classList.toggle('active', status === 'active');
                document.getElementById('filterSold').classList.toggle('active', status === 'sold');
                this.renderInventory();
            },

            switchTab(tab) {
                this.currentTab = tab;
                
                // Update tab buttons
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
                
                // Update tab content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`${tab}Tab`).classList.add('active');
                
                // Render the active tab
                if (tab === 'inventory') this.renderInventory();
                if (tab === 'summary') this.renderSummary();
                if (tab === 'people') this.renderPeople();
            },

            renderCycleSelector() {
                const cycleSelector = document.getElementById('cycleSelector');
                if (!cycleSelector) return;
                
                const options = Object.keys(this.cycles).map(cycleId => {
                    const cycle = this.cycles[cycleId];
                    const selected = parseInt(cycleId) === this.currentCycle ? 'selected' : '';
                    return `<option value="${cycleId}" ${selected}>${cycle.name}</option>`;
                }).join('');
                
                cycleSelector.innerHTML = options;
            },

            switchCycle(cycleId) {
                this.currentCycle = parseInt(cycleId);
                this.renderAll();
            },

            createNewCycle() {
                const cycleName = prompt('Enter name for new cycle:');
                if (!cycleName) return;
                
                const newCycleId = Math.max(...Object.keys(this.cycles).map(Number), 0) + 1;
                this.cycles[newCycleId] = {
                    name: cycleName,
                    data: [],
                    peopleData: []
                };
                
                this.currentCycle = newCycleId;
                this.saveToFirebase();
                this.renderCycleSelector();
                this.renderAll();
                alert(`New cycle "${cycleName}" created!`);
            },

            manageCycles() {
                const cycleEntries = Object.entries(this.cycles);
                const cycleListHTML = cycleEntries.map(([cycleId, cycle]) => `
                    <div style="padding: 16px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 500; color: #e2e8f0;">${cycle.name}</div>
                            <div style="font-size: 12px; color: #94a3b8;">${cycle.data?.length || 0} items, ${cycle.peopleData?.length || 0} people</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="edit-btn" onclick="app.renameCycle(${cycleId})">Rename</button>
                            ${cycleEntries.length > 1 ? `<button class="delete-btn" onclick="app.deleteCycle(${cycleId})">Delete</button>` : ''}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('cycleListContainer').innerHTML = cycleListHTML;
                document.getElementById('cycleModal').classList.add('show');
            },

            closeCycleModal() {
                document.getElementById('cycleModal').classList.remove('show');
            },

            renameCycle(cycleId) {
                const cycle = this.cycles[cycleId];
                const newName = prompt('Enter new name for cycle:', cycle.name);
                if (newName && newName.trim()) {
                    cycle.name = newName.trim();
                    this.saveToFirebase();
                    this.renderCycleSelector();
                    this.manageCycles();
                }
            },

            deleteCycle(cycleId) {
                const cycle = this.cycles[cycleId];
                if (confirm(`Are you sure you want to delete cycle "${cycle.name}"? This cannot be undone.`)) {
                    delete this.cycles[cycleId];
                    
                    // Switch to another cycle if the current one was deleted
                    if (this.currentCycle === parseInt(cycleId)) {
                        this.currentCycle = parseInt(Object.keys(this.cycles)[0]);
                    }
                    
                    this.saveToFirebase();
                    this.renderCycleSelector();
                    this.renderAll();
                    this.closeCycleModal();
                }
            },

            attachSearchListener() {
                document.getElementById('searchInput').addEventListener('input', () => {
                    this.renderInventory();
                });
                
                // Close modal when clicking outside
                document.getElementById('editModal').addEventListener('click', (e) => {
                    if (e.target.id === 'editModal') {
                        this.closeEditModal();
                    }
                });

                document.getElementById('cycleModal').addEventListener('click', (e) => {
                    if (e.target.id === 'cycleModal') {
                        this.closeCycleModal();
                    }
                });

                // Handle custom person name field
                document.getElementById('personName').addEventListener('change', (e) => {
                    const customGroup = document.getElementById('customPersonGroup');
                    if (e.target.value === 'Other') {
                        customGroup.style.display = 'block';
                    } else {
                        customGroup.style.display = 'none';
                    }
                });
            }
        };

        // Initialize on load
        window.addEventListener('load', () => app.init());
    </script>
</body>
</html>
